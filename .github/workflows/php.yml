name: PHP Composer

on:
  push:
    branches: [ main ]

jobs:
  Deployment:
    runs-on: self-hosted
    steps:
      - name: Push code to server
        uses: actions/checkout@v2
        
      - name: Validate composer.json and composer.lock
        run: /usr/local/bin/composer validate
        
      - name: Update & Install dependencies
        if: steps.composer-cache.outputs.cache-hit != 'true'
        run: /usr/local/bin/composer install --prefer-dist --no-progress --no-suggest
        
      - name: Maintenance Mode Up
        run: /usr/bin/php artisan down
        
      - name: Install Node JS Dependencies
        run: /usr/bin/npm install
        
      - name: Update Composer Dependencies
        run: /usr/local/bin/composer update
        
      - name: Update Node JS Dependencies
        run: /usr/bin/npm update
        
      - name: Set Up .env file
        run: echo -e "#DÃ©but du remplissage auto par github\r\n" > .env &&
            echo -e "APP_DEBUG=${{ secrets.ENV_APP_DEBUG }}\r\n" > .env &&
            echo -e "APP_ENV=${{ secrets.ENV_APP_ENV }}\r\n" > .env &&
            echo -e "APP_KEY=${{ secrets.ENV_APP_KEY }}\r\n" > .env &&
            echo -e "APP_NAME=${{ secrets.ENV_APP_NAME }}\r\n" > .env &&
            echo -e "APP_URL=${{ secrets.ENV_APP_URL }}\r\n" > .env &&
            echo -e "AWS_ACCESS_KEY_ID=${{ secrets.ENV_AWS_ACCESS_KEY_ID }}\r\n" > .env &&
            echo -e "AWS_BUCKET=${{ secrets.ENV_AWS_BUCKET }}\r\n" > .env &&
            echo -e "AWS_AWS_DEFAULT_REGION=${{ secrets.ENV_AWS_DEFAULT_REGION }}\r\n" > .env &&
            echo -e "AWS_SECRET_ACCESS_KEY=${{ secrets.ENV_AWS_SECRET_ACCESS_KEY }}\r\n" > .env &&
            echo -e "BROADCAST_DRIVER=${{ secrets.ENV_BROADCAST_DRIVER }}\r\n" > .env &&
            echo -e "CACHE_DRIVER=${{ secrets.ENV_CACHE_DRIVER }}\r\n" > .env &&
            echo -e "DB_CONNECTION=${{ secrets.ENV_DB_CONNECTION }}\r\n" > .env &&
            echo -e "DB_DATABASE=${{ secrets.ENV_DB_DATABASE }}\r\n" > .env &&
            echo -e "DB_HOST=${{ secrets.ENV_DB_HOST }}\r\n" > .env &&
            echo -e "DB_PASSWORD=${{ secrets.ENV_DB_PASSWORD }}\r\n" > .env &&
            echo -e "DB_PORT=${{ secrets.ENV_DB_PORT }}\r\n" > .env &&
            echo -e "DB_USERNAME=${{ secrets.ENV_DB_USERNAME }}\r\n" > .env &&
            echo -e "LOG_CHANNEL=${{ secrets.ENV_LOG_CHANNEL }}\r\n" > .env &&
            echo -e "MAIL_DRIVER=${{ secrets.ENV_MAIL_DRIVER }}\r\n" > .env &&
            echo -e "MAIL_ENCRYPTION=${{ secrets.ENV_MAIL_ENCRYPTION }}\r\n" > .env &&
            echo -e "MAIL_FROM_ADDRESS=${{ secrets.ENV_MAIL_FROM_ADDRESS }}\r\n" > .env &&
            echo -e "MAIL_FROM_NAME=${{ secrets.ENV_MAIL_FROM_NAME }}\r\n" > .env &&
            echo -e "MAIL_HOST=${{ secrets.ENV_MAIL_HOST }}\r\n" > .env &&
            echo -e "MAIL_PASSWORD=${{ secrets.ENV_MAIL_PASSWORD }}\r\n" > .env &&
            echo -e "MAIL_PORT=${{ secrets.ENV_MAIL_PORT }}\r\n" > .env &&
            echo -e "MAIL_USERNAME=${{ secrets.ENV_MAIL_USERNAME }}\r\n" > .env &&
            echo -e "MIX_PUSHER_APP_CLUSTER=${{ secrets.ENV_MIX_PUSHER_APP_CLUSTER }}\r\n" > .env &&
            echo -e "MIX_PUSHER_APP_KEY=${{ secrets.ENV_MIX_PUSHER_APP_KEY }}\r\n" > .env &&
            echo -e "PUSHER_APP_CLUSTER=${{ secrets.ENV_PUSHER_APP_CLUSTER }}\r\n" > .env &&
            echo -e "PUSHER_APP_ID=${{ secrets.ENV_PUSHER_APP_ID }}\r\n" > .env &&
            echo -e "PUSHER_APP_KEY=${{ secrets.ENV_PUSHER_APP_KEY }}\r\n" > .env &&
            echo -e "PUSHER_APP_SECRET=${{ secrets.ENV_PUSHER_APP_SECRET }}\r\n" > .env &&
            echo -e "QUEUE_CONNECTION=${{ secrets.ENV_QUEUE_CONNECTION }}\r\n" > .env &&
            echo -e "REDIS_HOST=${{ secrets.ENV_REDIS_HOST }}\r\n" > .env &&
            echo -e "REDIS_PASSWORD=${{ secrets.ENV_REDIS_PASSWORD }}\r\n" > .env &&
            echo -e "REDIS_PORT=${{ secrets.ENV_REDIS_PORT }}\r\n" > .env &&
            echo -e "SESSION_DRIVER=${{ secrets.ENV_SESSION_DRIVER }}\r\n" > .env &&
            echo -e "#Fin du remplissage auto par github" > .env
        
      - name: Compile Css & JS and Minify it
        run: /usr/bin/npm rebuild && /usr/bin/npm run prod
        
      - name: Generate key
        run: /usr/bin/php artisan key:generate
        
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
        
      - name: Maintenance Mode Down
        run: /usr/bin/php artisan up

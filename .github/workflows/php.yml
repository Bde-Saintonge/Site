name: PHP Composer

on:
  push:
    branches: [ main ]

jobs:
  Deployment:
    runs-on: self-hosted
    steps:
      - name: Push code to server
        uses: actions/checkout@v2
        
      - name: Validate composer.json and composer.lock
        run: /usr/local/bin/composer validate
        
      - name: Update & Install dependencies
        if: steps.composer-cache.outputs.cache-hit != 'true'
        run: /usr/local/bin/composer install --prefer-dist --no-progress --no-suggest
        
      - name: Maintenance Mode Up
        run: /usr/bin/php artisan down
        
      - name: Install Node JS Dependencies
        run: /usr/bin/npm install
        
      - name: Update Composer Dependencies
        run: /usr/local/bin/composer update
        
      - name: Update Node JS Dependencies
        run: /usr/bin/npm update
        
      - name: Set Up .env file
        run: echo -e "#DÃ©but du remplissage auto par github\r\nAPP_DEBUG=${{ secrets.ENV_APP_DEBUG }}\r\nAPP_ENV=${{ secrets.ENV_APP_ENV }}\r\nAPP_KEY=${{ secrets.ENV_APP_KEY }}\r\nAPP_NAME=${{ secrets.ENV_APP_NAME }}\r\nAPP_URL=${{ secrets.ENV_APP_URL }}\r\nAWS_ACCESS_KEY_ID=${{ secrets.ENV_AWS_ACCESS_KEY_ID }}\r\nAWS_BUCKET=${{ secrets.ENV_AWS_BUCKET }}\r\nAWS_AWS_DEFAULT_REGION=${{ secrets.ENV_AWS_DEFAULT_REGION }}\r\nAWS_SECRET_ACCESS_KEY=${{ secrets.ENV_AWS_SECRET_ACCESS_KEY }}\r\nBROADCAST_DRIVER=${{ secrets.ENV_BROADCAST_DRIVER }}\r\nCACHE_DRIVER=${{ secrets.ENV_CACHE_DRIVER }}\r\nDB_CONNECTION=${{ secrets.ENV_DB_CONNECTION }}\r\nDB_DATABASE=${{ secrets.ENV_DB_DATABASE }}\r\nDB_HOST=${{ secrets.ENV_DB_HOST }}\r\nDB_PASSWORD=${{ secrets.ENV_DB_PASSWORD }}\r\nDB_PORT=${{ secrets.ENV_DB_PORT }}\r\nDB_USERNAME=${{ secrets.ENV_DB_USERNAME }}\r\nLOG_CHANNEL=${{ secrets.ENV_LOG_CHANNEL }}\r\nMAIL_DRIVER=${{ secrets.ENV_MAIL_DRIVER }}\r\nMAIL_ENCRYPTION=${{ secrets.ENV_MAIL_ENCRYPTION }}\r\nMAIL_FROM_ADDRESS=${{ secrets.ENV_MAIL_FROM_ADDRESS }}\r\nMAIL_FROM_NAME=${{ secrets.ENV_MAIL_FROM_NAME }}\r\nMAIL_HOST=${{ secrets.ENV_MAIL_HOST }}\r\nMAIL_PASSWORD=${{ secrets.ENV_MAIL_PASSWORD }}\r\nMAIL_PORT=${{ secrets.ENV_MAIL_PORT }}\r\nMAIL_USERNAME=${{ secrets.ENV_MAIL_USERNAME }}\r\nMIX_PUSHER_APP_CLUSTER=${{ secrets.ENV_MIX_PUSHER_APP_CLUSTER }}\r\nMIX_PUSHER_APP_KEY=${{ secrets.ENV_MIX_PUSHER_APP_KEY }}\r\nPUSHER_APP_CLUSTER=${{ secrets.ENV_PUSHER_APP_CLUSTER }}\r\nPUSHER_APP_ID=${{ secrets.ENV_PUSHER_APP_ID }}\r\nPUSHER_APP_KEY=${{ secrets.ENV_PUSHER_APP_KEY }}\r\nPUSHER_APP_SECRET=${{ secrets.ENV_PUSHER_APP_SECRET }}\r\nQUEUE_CONNECTION=${{ secrets.ENV_QUEUE_CONNECTION }}\r\nREDIS_HOST=${{ secrets.ENV_REDIS_HOST }}\r\nREDIS_PASSWORD=${{ secrets.ENV_REDIS_PASSWORD }}\r\nREDIS_PORT=${{ secrets.ENV_REDIS_PORT }}\r\nSESSION_DRIVER=${{ secrets.ENV_SESSION_DRIVER }}\r\n#Fin du remplissage auto par github" > .env
        
      - name: Compile Css & JS and Minify it
        run: /usr/bin/npm rebuild && /usr/bin/npm run prod
        
      - name: Generate key
        run: /usr/bin/php artisan key:generate
        
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
        
      - name: Maintenance Mode Down
        run: /usr/bin/php artisan up
